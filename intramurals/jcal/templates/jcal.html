<html>
<head>
</head>
<body>


<div class="cal-div">
<table id="cal">
</table>
</div>




<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js"></script>
<script src="http://plugins.jquery.com/files/jquery.dump.js.txt"></script>
<script src="http://cse.taylor.edu/~sbird/js/jquery-ui-1.7.2/ui/jquery-ui.js"></script>
<script src="http://datejs.googlecode.com/files/date.js"></script>
<script src="http://cse.taylor.edu/~sbird/js/std.js"></script>
<script src="http://cse.taylor.edu/~sbird/js/date2.js"></script>

<script>
// 'next' is the function passed to iterate that will 
//   return false when the iteration is complete
// 'go' is the function passed to iterate that will
//   generate the next day or week
var iterate = function(next, go) {
  var n;
  while(n = next()) {
    go(n)
  }
};

var makeDay = function(weekDOM, date) {
  var _class = 'cal-day cal-' + date.getMonthName();
  date.setHours(0);
$('<td class="'+_class+'" >'+payload.get(date)+'</td>').appendTo(weekDOM);
};

var iterateTimeSegmentFn = function(s,e, next) {
  var start = s;
  var end = e;
  var date = new Date(start);
  
  next = next || function(date) { date.next().day() };

  var firsttime = true;

  return function() {
    if(firsttime) {
      firsttime = false;
      return date;
    } else if(date >= start && date < end) {
      next(date);
      return date;
    }
    return false;
  };
};
var iterateDistFn = iterateTimeSegmentFn;

// This is a helper function for makeWeek
// w is the day of which we are displaying the week
var iterateWeekFn = function(w) {
  w.thisWeek().prev().sun(); //sets w to Sunday of the week it is in

  var start = new Date(w);
  var end = new Date(w.next().sat()); //sets end to the Saturday of the week it is in

  return iterateTimeSegmentFn(start, end);

};

// displays a calendar view of the week of given date
var makeWeek = function(w) {
  var tr = $('<tr/>')[0];
  $('#cal').append(tr);
  iterate(iterateWeekFn(w), function(date) { makeDay(tr, date)});
}

// This is a helper function for makeWist
var iterateWistFn = function(start, end) {

  var next = function(date) { date.next().mon(); }

  return iterateTimeSegmentFn(start, end, next);

}

// displays a calendar view from given start date to given end date
var makeWist = function(start, end) {
  iterate(iterateWistFn(start.thisWeek(),
                        end.thisWeek() ),
          makeWeek);
};

var payload = {};
payload.get = function(date) {
  if(! payload[date] ) {
    payload[date] = date.getDate() + '<hr/>';
  }
  return payload[date];
};
payload.inc = function(date, value) {
  payload.get(date); //this is to set payload[date] if it is undefined.
  payload[date] += value;
};

</script>

<div id="alpha"></div>
<script>
var ajax_gameJson2Html = function(data, textStatus) {
  var json = eval(data);
  var args = this.args;
  var start = Date.parse(args.start);
  start.setHours(0);
  var end = Date.parse(args.end);
  start.setHours(0);

  for(k in json) {
    var game = json[k]
    var date = Date.parse(game.fields.StartTime);
    date.setHours(0); //makeDay function assumes that all indexes have a zero hour.
    payload.inc(date, '<a href="#">' + game.fields.HomeTeam.fields.Name + '<br/>' +
                                       game.fields.AwayTeam.fields.Name + '</a><hr/>');
  }

};

var getGames = function(start, end, fn) {
  fn = fn || ajax_gameJson2Html;

  $.ajax({
    url:"/getGames",
    type: "get",
    data: {
      'start':start,
      'end':end
    },
    args: {
      "start":start,
      "end":end
    },
    success: fn
  });
};

//getGames('2009-9-16', '2009-9-18');
gstart = '2009-9-16';
gend = '2009-9-18';

//getGames(gstart, gend, ajax_gameJson2Html);
makeWist(gstart, gend);
</script>

<style>
.cal-div
{
}
#cal td
{
  border-style: solid;
  vertical-align: top;
}
#cal
{
  border-collapse:collapse;
}

.cal-September
{
  //background-color:blue;
}
</style>


</body>
</html>
